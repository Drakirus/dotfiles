#!/bin/bash
IFS=$'\n\t'


#
# Modification of Remco Verhoef <remco@dutchcoders.io>
#

getpassword(){
  unset PASSWORD
  prompt="Enter Password: "
  while IFS= read -p "$prompt" -r -s -n 1 char
  do
    if [[ $char == $'\0' ]]
    then
      break
    fi
    prompt='*'
    PASSWORD+="$char"
  done
  echo -e "\n"
}

curl --version 2>&1 > /dev/null
if [ $? -ne 0 ]; then
  echo "Could not find curl."
  exit 1
fi


# check arguments
if [ $# -eq 0 ];
then
  echo "No arguments specified. Usage:\necho transfer /tmp/test.md\ncat /tmp/test.md | transfer test.md"
  exit 1
fi

# get temporarily filename, output is written to this file show progress can be showed
tmpfile=$( mktemp -t transferXXX )

# upload stdin or file
file=$1

if tty -s;
then
  basefile=$(basename "$file" | sed -e 's/[^a-zA-Z0-9._-]/-/g')

  if [ ! -e $file ];
  then
    echo "File $file doesn't exists."
    exit 1
  fi

  if [ -d $file ];
  then
    # zip directory and transfer
    zipfile=$( mktemp -t transferXXX.zip )
    cd $(dirname $file) && zip -r -q - $(basename $file) >> $zipfile
    curl --progress-bar --upload-file "$zipfile" "https://transfer.sh/$basefile.zip" >> $tmpfile
    rm -f $zipfile
  else
    # transfer file
    curl --progress-bar --upload-file "$file" "https://transfer.sh/$basefile" >> $tmpfile
  fi
else
  # transfer pipe
  curl --progress-bar --upload-file "-" "https://transfer.sh/$file" >> $tmpfile
fi

# cat output link
echo -e "\nLink :"
cat $tmpfile

LINK=`cat $tmpfile`

# cleanup
rm -f $tmpfile


# save link to github gist
DATE=`date +%A-%d-%B`
HOUR=`date +%H:%M`
CONFIG_FILE=~/.uploadGistList


if [ ! -e $CONFIG_FILE ]; then
  echo -e "\nCreate new token for a gist\n"
  read -p "Github account: " ACCOUNT
  getpassword
  curl -s -i -H "Content-Type: application/json" -u $ACCOUNT:$PASSWORD -d '{"scopes":["gist"],"note":"Upload_APP_'$DATE$HOUR'"}' https://api.github.com/authorizations | grep \"token\" | awk '{ print $2 }' | sed s/\"//g | sed s/,//g > $CONFIG_FILE

  if [ $? -ne 1 ]; then
    echo "Token Saved to ~/.uploadGistList"
    echo $ACCOUNT >> $CONFIG_FILE
  else
    echo "Failed to generate token"
    exit 1
  fi

  TOKEN_ID=$( head -1 $CONFIG_FILE | tail -n 1 )


  curl -s  https://api.github.com/users/$ACCOUNT/gists | grep "Upload.md" 2>&1 > /dev/null
  if [ $? -ne 0 ]; then
    curl -s -i -H  "Authorization: token $TOKEN_ID" -d '{"description":"Upload List", "public":"true", "files":{"Upload.md":{"content":"Uploaded list\n==\n *   '$DATE'  **'$HOUR'**   ['$file' ]('$LINK')" }}' https://api.github.com/gists | grep \"id\" | awk '{ print $2 }' | sed s/\"//g | sed s/,//g | head -1 >> $CONFIG_FILE
    if [ $? -ne 1 ]; then
      echo "New Gist created"
      exit 0
    else
      echo "Failed create Gist"
    fi
  else
   curl -s  https://api.github.com/users/$ACCOUNT/gists | grep -B 6 "Upload.md" |  grep \"id\" | awk '{ print $2  }' | sed s/\"//g | sed s/,//g | head -1 >> $CONFIG_FILE
  fi

else


  TOKEN_ID=$( head -1 $CONFIG_FILE | tail -n 1 )
  USERGIT=$( head -2 $CONFIG_FILE | tail -n 1  )
  ID_GIST=$(tail ~/.uploadGistList -n 1)
  OLD_TEXT=$(curl -s  https://api.github.com/users/$USERGIT/gists |  grep -A 6 "Upload.md" |  grep \"raw_url\" | awk '{ print $2  }' | sed s/\"//g | sed s/,//g | head -1 )
  OLD_TEXT=$(curl -s "$OLD_TEXT" )
  ESCAPE_TEXT=$(printf  '%q' "$OLD_TEXT" | sed s/^$\'//g | sed s/\'$//g)
  #echo $ESCAPE_TEXT
  curl -s --request PATCH -H "Authorization: token $TOKEN_ID" -d '{"description": "updated list","public": true,"files": {"Upload.md": {"content": "'$ESCAPE_TEXT'\n *   '$DATE'  **'$HOUR'**   ['$file' ]('$LINK')"}}}' https://api.github.com/gists/$ID_GIST   2>&1 > /dev/null

fi


